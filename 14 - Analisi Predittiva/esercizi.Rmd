---
title: "CT0429 - Analisi Predittiva - aa 21/22 - Appello IV"
author: "Nome Cognome - matricola"
output: 
  html_document: 
    toc: yes
---

# Istruzioni

Salvate questo file con il nome `matricola.Rmd`. Questo sarà il file che dovrete consegnare. Il file deve compilare senza problemi: files che non possono essere compilati correttamente saranno penalizzati. 


Per essere sicuri di poter trovare il file al momento della consegna potete controllare dove è il file quando compilate il file la prima volta usando il comando `getwd()`. 

```{r}
getwd()
## da cancellare quando siete sicuri di dove è il file
```


Attenzione - per tutto l'esame, se non specificato esplicitamente, il livello di significatività da usare è $\alpha = 0.02$


# Esercizio 1

Un app di smart-mobility desidera indagare quali fattori influenzino l'utilizzo degli utenti dei mezzi messi a disposizione dalla app. Per un campione di 70 giorni in diverse città nei mesi di Aprile e Maggio vengono misurate le seguenti informazioni: 

* `n_mezzi`: il numero minimo di mezzi funzionanti e operativi nella giornata 
* `temp`: la temperatura media della giornata
* `weekend`: una variabile che indica se la giornata era un sabato o domenica 
* `usage`: una variabile che indica il numero di chilometri (in migliaia) coperto dagli utenti nella giornata. Questa è la variabile risposta

Le informazioni sulle variabili sono disponibili nel dataset `dex1` che si può caricare usando il seguente codice: 

```{r,cache=TRUE}
dex1 <- read.csv("ex1_data.csv", header = TRUE)
dex1
```



### Es. 1.a 

```{asis}
Si costruisca un primo modello lineare multiplo `fit1` in cui tutte le variabili esplicative vengono utilizzate. Si commenti la significatività del modello e dei singoli predittori. Si verifichi l'opportunità di proporre un modello più parsimonioso di `fit1`. 
```

```{r}
fit1 <- lm(usage~n_mezzi+temp+weekend, data = dex1)
summary(fit1)
plot(fit1)
```
I predittori di questo modello sono tutti molto significativi, escluso il parametro booleano "weekend": l'utilizzo aumenta all'aumentare del numero di mezzi disponibili e della temperatura media della giornata. Il weekend invece ha correlazione negativa, anche se non è significativo e potrebbe aver senso eliminarlo per avere un modello più parsimonioso


### Es. 1.b 

```{asis}
Si derivino intervalli di confidenza (a livello di confidenza 98\%) per il coefficiente angolare relativo alla variabile `temp` nel modello `fit11`. Si verifichi inoltre il sistema di ipotesi $H_0: \beta_{temp} = 1$ VS $H_1: \beta_{temp} \neq 1$
```

```{r}
confint(fit1, level = 0.98) 
```
l'intervallo di confidenza del \beta relativo a temp è [0.5893622,  1.2512911]. siccome 1 è compreso nell'intervallo di confidenza, non possiamo rifiutare quest'ipotesi



### Es. 1.c

```{asis}
Si produca una visualizzazione che mostri i valori stimati dal modello prescelto per giornate feriali con 20 e 25 gradi e tra i 150 e i 210 mezzi disponibili. 
```

```{r}
nd <- data.frame(
  temp = rep(c(20, 25), each = 61),     # 20 ripetuto 61 volte, poi 25 ripetuto 61 volte
  n_mezzi = rep(150:210, times = 2),    # sequenza 150–210 ripetuta per i due blocchi
  weekend = "no"
)

# calcolo valori stimati
nd$fit <- predict(fit1, newdata = nd)

a <- predict(fit1, newdata = nd)
plot (nd$fit~nd$n_mezzi)

```



### Es. 1.d

```{asis}
Il CEO dell'azienda desidera valutare l'opportunità di aumentare il numero di mezzi nelle città per il prossimo inverno: è possibile utilizzare il modello selezionato per predirre il numero di chilometri che saranno coperti dagli utenti nei mesi di Dicembre e Gennaio? 
```


```{r}
summary(dex1)
```
no perché la temperatura minima è 15 gradi, quindi i dati "invernali" sono troppo fuori dal range e la stima perde di significato

# Esercizio 2

Un ristoratore monitora il numero di ordini fatti tramite un app di food-delivery e desidera indagare quali siano i fattori che inducono gli utenti ad ordinare presso il suo ristorante. Le variabili che prende in considerazione sono 


* `domenica`: una variabile che indica se la giornata è una Domenica
* `temp`: la temperatura media giornaliera 
* `nOrd`: il numero di ordini ricevuti in una serata. Questa è la variabile risposta. 


Si carichi il dataset usando il codice seguente:  

```{r,cache=TRUE}
dex2 <- read.csv("ex2_data.csv", header = TRUE)
dex2$domenica <- factor(dex2$domenica) 
head(dex2)
```

Si desidera costruire un modello predittivo per la variabile `nOrd`, un modello cioè che predica il numero di ordini, usando un modello lineare generalizzato usando una distribuzione di Poisson con funzione legame canonica in cui la variabile `nOrd` è la variabile risposta. 


### Es. 2.a 

```{asis}
Si verifichi se la temperatura è un predittore significativo, verificando inoltre se è conveniente usare termini polinomiali di ordine superiore ad uno (questo si può fare usando la funzione `I` o la funzione `poly`). 
```

```{r}
fit <- glm(nOrd~temp, data = dex2, family = "poisson")
summary(fit)
plot(nOrd~temp, data = dex2)
plot(fit)
```

la temperatura è blandamente significativa, i punti hanno una forma vagamente parabolica, conviene quindi indagare i polinomi di ordine superiore all'1
```{r}
fit2 <- glm(nOrd~poly(temp, 2), data = dex2, family = "poisson")
summary(fit2)
plot(fit2)
```
È significativo il monomio del secondo ordine. polinomi di ordine superiore non risultano necessari per predire nOrd


### Es. 2.b

```{asis}
Usando il modello migliore che si è scelto al punto a) si verifichi se, a parità di temperatura, vi è una qualche differenza nel numero di ordini effettuati la domenica o nelle altre giornate. 
```

```{r}
fit_dom <- glm(nOrd ~ poly(temp, 2) + domenica, data = dex2, family = poisson)
summary(fit_dom)
```

il predittore Domenica è molto significativo, la correlazione è positiva. Anche considerando il criterio AIC, il nuovo modello è decisamente migliore del secondo

### Es. 2.c 

```{asis}
Usando il modello che si ritiene migliore si produca una stima del numero medio di ordini attesi per le giornate nel dataset `nd`. Si produca anche una stima intervallare usando un livello di confidenza pari al 98\%.
```

```{r}
nd <- data.frame(temp = c(16, 16, 26, 26), domenica = factor(c(0,1,0,1)))
rownames(nd) <- c("g16","d16","g26","d26")

pred <- predict(fit_dom, newdata = nd, type = "link", se.fit = TRUE)
z <- qnorm(1 - 0.02/2)  # circa 2.33

nd$fit    <- exp(pred$fit)                       # stima attesa
nd$lower  <- exp(pred$fit - z * pred$se.fit)     # limite inferiore CI
nd$upper  <- exp(pred$fit + z * pred$se.fit)     # limite superiore CI

nd
```





### Es. 2.d

```{asis}
Quale è la funzione legame usata quando si usa la funzione legame canonica per la distribuzione Poisson? Per il modello utilizzato al punto c) si provi ad usare la funzione legame radice quadrata (`link = sqrt`) e si verifichi se i valori puntuali stimati del numero di ordini differiscono quando si usa una diversa funzione legame. 
```

la funzione legame canonica per la distribuzione poisson è la logaritmica. 

```{r, error=TRUE}
fit_rad <- glm(nOrd ~ poly(temp, 2) + domenica, data = dex2, family = poisson(link = "sqrt"))
summary(fit_rad)
```
```{r}

nd <- data.frame(temp = c(16, 16, 26, 26), domenica = factor(c(0,1,0,1)))
rownames(nd) <- c("g16","d16","g26","d26")

pred2 <- predict(fit_rad, newdata = nd, type = "link", se.fit = TRUE)
z <- qnorm(1 - 0.02/2)  # circa 2.33

nd$fit    <- (pred2$fit)^2                       # stima attesa
nd$lower  <- (pred2$fit - z * pred$se.fit)^2     # limite inferiore CI
nd$upper  <- (pred2$fit + z * pred$se.fit)^2     # limite superiore CI

nd


```
sono diversi ma abbastanza simili
